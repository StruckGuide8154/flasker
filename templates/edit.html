<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced File Explorer</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .CodeMirror {
            height: calc(100vh - 200px);
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <div class="flex">
            <div id="file-explorer" class="w-1/3 bg-white p-4 rounded shadow overflow-y-auto h-screen">
                <h2 class="text-xl font-bold mb-4">File Explorer</h2>
                <div class="mb-4 flex flex-wrap">
                    <button id="new-file-btn" class="bg-green-500 text-white px-2 py-1 rounded mr-2 mb-2">New File</button>
                    <button id="new-folder-btn" class="bg-blue-500 text-white px-2 py-1 rounded mr-2 mb-2">New Folder</button>
                    <button id="upload-btn" class="bg-purple-500 text-white px-2 py-1 rounded mr-2 mb-2">Upload</button>
                    <button id="refresh-btn" class="bg-gray-500 text-white px-2 py-1 rounded mb-2">Refresh</button>
                    <input type="file" id="file-upload" class="hidden">
                </div>
                <div id="breadcrumb" class="text-sm text-gray-600 mb-2"></div>
                <ul id="file-list" class="space-y-1"></ul>
            </div>
            <div id="editor" class="w-2/3 ml-4 bg-white p-4 rounded shadow h-screen flex flex-col">
                <h2 class="text-xl font-bold mb-4">Editor</h2>
                <div id="code-editor" class="flex-grow"></div>
                <div class="mt-4 flex justify-between">
                    <div>
                        <button id="save-btn" class="bg-blue-500 text-white px-4 py-2 rounded mr-2">Save</button>
                        <button id="download-btn" class="bg-green-500 text-white px-4 py-2 rounded mr-2">Download</button>
                        <button id="copy-btn" class="bg-yellow-500 text-white px-4 py-2 rounded mr-2">Copy</button>
                        <button id="move-btn" class="bg-indigo-500 text-white px-4 py-2 rounded">Move</button>
                    </div>
                    <div>
                        <button id="rename-btn" class="bg-yellow-500 text-white px-4 py-2 rounded mr-2">Rename</button>
                        <button id="delete-btn" class="bg-red-500 text-white px-4 py-2 rounded">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPath = '/';
        let editor;
        let currentFile = null;

        function loadFileExplorer(path) {
            fetch('/edit', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: `action=list&path=${encodeURIComponent(path)}`
            })
            .then(response => response.json())
            .then(data => {
                const fileList = document.getElementById('file-list');
                fileList.innerHTML = '';
                data.sort((a, b) => a.is_dir === b.is_dir ? a.name.localeCompare(b.name) : b.is_dir - a.is_dir);
                data.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center justify-between cursor-pointer hover:bg-gray-200 p-2 rounded';
                    li.innerHTML = `
                        <span>${item.is_dir ? 'üìÅ' : 'üìÑ'} ${item.name}</span>
                        <span class="text-sm text-gray-500">${formatFileSize(item.size)}</span>
                    `;
                    li.ondblclick = () => handleItemDoubleClick(item);
                    li.onclick = (e) => handleItemClick(e, item);
                    fileList.appendChild(li);
                });
                updateBreadcrumb();
            });
        }

        function formatFileSize(size) {
            if (size < 1024) return size + ' B';
            if (size < 1024 * 1024) return (size / 1024).toFixed(2) + ' KB';
            if (size < 1024 * 1024 * 1024) return (size / (1024 * 1024)).toFixed(2) + ' MB';
            return (size / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
        }

        function updateBreadcrumb() {
            const breadcrumb = document.getElementById('breadcrumb');
            const parts = currentPath.split('/').filter(Boolean);
            breadcrumb.innerHTML = '<span class="cursor-pointer" onclick="navigateTo(\'/\')">root</span>';
            let path = '';
            parts.forEach(part => {
                path += '/' + part;
                breadcrumb.innerHTML += ` / <span class="cursor-pointer" onclick="navigateTo('${path}')">${part}</span>`;
            });
        }

        function navigateTo(path) {
            currentPath = path;
            loadFileExplorer(currentPath);
        }

        function handleItemDoubleClick(item) {
            if (item.is_dir) {
                currentPath = `${currentPath}${item.name}/`;
                loadFileExplorer(currentPath);
            } else {
                openFile(`${currentPath}${item.name}`);
            }
        }

        function handleItemClick(e, item) {
            const selected = document.querySelector('.bg-blue-100');
            if (selected) selected.classList.remove('bg-blue-100');
            e.currentTarget.classList.add('bg-blue-100');
            currentFile = `${currentPath}${item.name}`;
        }

        function openFile(path) {
            fetch('/edit', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: `action=read&path=${encodeURIComponent(path)}`
            })
            .then(response => response.json())
            .then(data => {
                editor.setValue(data.content);
                editor.setOption('mode', getFileMode(path));
                currentFile = path;
            });
        }

        function getFileMode(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            switch (ext) {
                case 'js': return 'javascript';
                case 'html': return 'htmlmixed';
                case 'py': return 'python';
                default: return 'text/plain';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            editor = CodeMirror(document.getElementById('code-editor'), {
                lineNumbers: true,
                theme: 'monokai',
                mode: 'javascript',
                autoCloseBrackets: true,
                matchBrackets: true
            });

            loadFileExplorer(currentPath);

            document.getElementById('save-btn').onclick = () => {
                if (!currentFile) {
                    Swal.fire('Error', 'No file is currently open', 'error');
                    return;
                }
                fetch('/edit', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `action=write&path=${encodeURIComponent(currentFile)}&content=${encodeURIComponent(editor.getValue())}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire('Success', 'File saved successfully', 'success');
                    } else {
                        Swal.fire('Error', data.error, 'error');
                    }
                });
            };

            document.getElementById('new-file-btn').onclick = () => {
                Swal.fire({
                    title: 'Create New File',
                    input: 'text',
                    inputLabel: 'File Name',
                    showCancelButton: true,
                    inputValidator: (value) => {
                        if (!value) {
                            return 'You need to write something!';
                        }
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch('/edit', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                            body: `action=create_file&path=${encodeURIComponent(currentPath)}&name=${encodeURIComponent(result.value)}`
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                loadFileExplorer(currentPath);
                                Swal.fire('Success', 'File created successfully', 'success');
                            } else {
                                Swal.fire('Error', data.error, 'error');
                            }
                        });
                    }
                });
            };

            document.getElementById('new-folder-btn').onclick = () => {
                Swal.fire({
                    title: 'Create New Folder',
                    input: 'text',
                    inputLabel: 'Folder Name',
                    showCancelButton: true,
                    inputValidator: (value) => {
                        if (!value) {
                            return 'You need to write something!';
                        }
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch('/edit', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                            body: `action=create_folder&path=${encodeURIComponent(currentPath)}&name=${encodeURIComponent(result.value)}`
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                loadFileExplorer(currentPath);
                                Swal.fire('Success', 'Folder created successfully', 'success');
                            } else {
                                Swal.fire('Error', data.error, 'error');
                            }
                        });
                    }
                });
            };

            document.getElementById('upload-btn').onclick = () => {
                document.getElementById('file-upload').click();
            };

            document.getElementById('file-upload').onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('file', file);
                formData.append('action', 'upload');
                formData.append('path', currentPath);

                fetch('/edit', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadFileExplorer(currentPath);
                        Swal.fire('Success', 'File uploaded successfully', 'success');
                    } else {
                        Swal.fire('Error', data.error, 'error');
                    }
                });
            };

            document.getElementById('download-btn').onclick = () => {
                if (!currentFile) {
                    Swal.fire('Error', 'No file is currently selected', 'error');
                    return;
                }
                window.open(`/edit?action=download&path=${encodeURIComponent(currentFile)}`, '_blank');
            };

            document.getElementById('rename-btn').onclick = () => {
                if (!currentFile) {
                    Swal.fire('Error', 'No file is currently selected', 'error');
                    return;
                }
                Swal.fire({
                    title: 'Rename File/Folder',
                    input: 'text',
                    inputLabel: 'New Name',
                    inputValue: currentFile.split('/').pop(),
                    showCancelButton: true,
                    inputValidator: (value) => {
                        if (!value) {
                            return 'You need to write something!';
                        }
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch('/edit', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                            body: `action=rename&path=${encodeURIComponent(currentFile)}&new_name=${encodeURIComponent(result.value)}`
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                loadFileExplorer(currentPath);
                                Swal.fire('Success', 'File/Folder renamed successfully', 'success');
                            } else {
                                Swal.fire('Error', data.error, 'error');
                            }
                        });
                    }
                });
            };

document.getElementById('delete-btn').onclick = () => {
                if (!currentFile) {
                    Swal.fire('Error', 'No file or folder is currently selected', 'error');
                    return;
                }
                Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch('/edit', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                            body: `action=delete&path=${encodeURIComponent(currentFile)}`
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                loadFileExplorer(currentPath);
                                Swal.fire('Deleted!', 'Your file has been deleted.', 'success');
                                editor.setValue('');
                                currentFile = null;
                            } else {
                                Swal.fire('Error', data.error, 'error');
                            }
                        });
                    }
                });
            };

            document.getElementById('copy-btn').onclick = () => {
                if (!currentFile) {
                    Swal.fire('Error', 'No file or folder is currently selected', 'error');
                    return;
                }
                Swal.fire({
                    title: 'Copy To',
                    input: 'text',
                    inputLabel: 'Destination Path',
                    inputValue: currentPath,
                    showCancelButton: true,
                    inputValidator: (value) => {
                        if (!value) {
                            return 'You need to specify a destination!';
                        }
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch('/edit', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                            body: `action=copy&path=${encodeURIComponent(currentFile)}&destination=${encodeURIComponent(result.value)}`
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                loadFileExplorer(currentPath);
                                Swal.fire('Success', 'File/Folder copied successfully', 'success');
                            } else {
                                Swal.fire('Error', data.error, 'error');
                            }
                        });
                    }
                });
            };

            document.getElementById('move-btn').onclick = () => {
                if (!currentFile) {
                    Swal.fire('Error', 'No file or folder is currently selected', 'error');
                    return;
                }
                Swal.fire({
                    title: 'Move To',
                    input: 'text',
                    inputLabel: 'Destination Path',
                    inputValue: currentPath,
                    showCancelButton: true,
                    inputValidator: (value) => {
                        if (!value) {
                            return 'You need to specify a destination!';
                        }
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch('/edit', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                            body: `action=move&path=${encodeURIComponent(currentFile)}&destination=${encodeURIComponent(result.value)}`
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                loadFileExplorer(currentPath);
                                Swal.fire('Success', 'File/Folder moved successfully', 'success');
                                if (currentFile.startsWith(currentPath)) {
                                    editor.setValue('');
                                    currentFile = null;
                                }
                            } else {
                                Swal.fire('Error', data.error, 'error');
                            }
                        });
                    }
                });
            };

            document.getElementById('refresh-btn').onclick = () => {
                loadFileExplorer(currentPath);
            };

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch (e.key.toLowerCase()) {
                        case 's':
                            e.preventDefault();
                            document.getElementById('save-btn').click();
                            break;
                        case 'o':
                            e.preventDefault();
                            document.getElementById('upload-btn').click();
                            break;
                        case 'n':
                            e.preventDefault();
                            document.getElementById('new-file-btn').click();
                            break;
                    }
                }
            });

            // Context menu
            document.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                if (e.target.closest('#file-list')) {
                    const contextMenu = document.createElement('div');
                    contextMenu.className = 'absolute bg-white border border-gray-300 rounded shadow-lg z-50';
                    contextMenu.style.left = `${e.pageX}px`;
                    contextMenu.style.top = `${e.pageY}px`;
                    contextMenu.innerHTML = `
                        <button class="block w-full text-left px-4 py-2 hover:bg-gray-100" id="context-rename">Rename</button>
                        <button class="block w-full text-left px-4 py-2 hover:bg-gray-100" id="context-delete">Delete</button>
                        <button class="block w-full text-left px-4 py-2 hover:bg-gray-100" id="context-copy">Copy</button>
                        <button class="block w-full text-left px-4 py-2 hover:bg-gray-100" id="context-move">Move</button>
                    `;
                    document.body.appendChild(contextMenu);

                    contextMenu.querySelector('#context-rename').onclick = () => document.getElementById('rename-btn').click();
                    contextMenu.querySelector('#context-delete').onclick = () => document.getElementById('delete-btn').click();
                    contextMenu.querySelector('#context-copy').onclick = () => document.getElementById('copy-btn').click();
                    contextMenu.querySelector('#context-move').onclick = () => document.getElementById('move-btn').click();

                    document.addEventListener('click', () => contextMenu.remove(), { once: true });
                }
            });
        });
    </script>
</body>
</html>
